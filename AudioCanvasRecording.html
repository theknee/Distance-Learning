f<title>Audio + Canvas2D/HTML recording using RecordRTC!</title>
<style>
    body {overflow-x:hidden;background: rgb(233, 233, 233);}
    #elementToShare {
        background: rgb(233, 233, 233);
        font-size: 2em;
        height: 100%;
        left: 0;
        padding: 0 1em;
        position: absolute;
        top: 0;
        width: 100%;
    }
    
    button, input[type=button] {
        -moz-border-radius: 3px;
        -moz-transition: none;
        -webkit-transition: none;
        background: #0370ea;
        background: -moz-linear-gradient(top, #008dfd 0, #0370ea 100%);
        background: -webkit-linear-gradient(top, #008dfd 0, #0370ea 100%);
        border: 1px solid #076bd2;
        border-radius: 3px;
        color: #fff;
        display: inline-block;
        font-family: inherit;
        font-size: .8em;
        font-size: 1.5em;
        line-height: 1.3;
        padding: 5px 12px;
        text-align: center;
        text-shadow: 1px 1px 1px #076bd2;
    }

    button:hover, input[type=button]:hover { background: rgb(9, 147, 240); }

    button:active, input[type=button]:active { background: rgb(10, 118, 190); }

    button[disabled], input[type=button][disabled] {
        background: none;
        border: 1px solid rgb(187, 181, 181);
        color: gray;
        text-shadow: none;
    }
    a {
        color: #2844FA;
        cursor: pointer;
        text-decoration: none;
    }
    a:hover, a:focus { color: #1B29A4; }
    a:active { color: #000; }
</style>

<div id="elementToShare" class="col-lg-8 col-xs-8 col-sm-8" style="margin-top:3px;">
  <video autoplay="true" id="videoElement"></video>
</div>
     
<div style="position: fixed;top;0;left: 20%;right: 20%;text-align: center;">
    <button id="start">Start </button>
    <button id="stop" disabled>Stop </button>
    <button id="download-url" disabled>Save </button>
</div>

<script src="https://www.webrtc-experiment.com/screenshot.js"> </script>
<script src="https://www.webrtc-experiment.com/RecordRTC.js"> </script>

<script>
var elementToShare = document.getElementById('elementToShare');
var canvasRecorder = RecordRTC(elementToShare, {
    type: 'canvas',
});

var recordAudio;

document.getElementById('start').onclick = function() {
    this.disabled = true;
    navigator.getUserMedia({ audio: true }, function(stream) {
        recordAudio = RecordRTC(stream, {
            // bufferSize: 16384.
            onAudioProcessStarted: function() {
                canvasRecorder.startRecording();
            }
        });
        recordAudio.startRecording();
        document.getElementById('stop').disabled = false;
    }, function(error) { log( JSON.stringify ( error ) ); });
};
document.getElementById('stop').onclick = function() {
    this.disabled = true;
    recordAudio.stopRecording(function() {
        canvasRecorder.stopRecording(function() {
        convertStreams(canvasRecorder.getBlob(), recordAudio.getBlob());
        });
    });
    
    document.getElementById('start').disabled = false;
};


 //var workerPath = location.href.replace(location.href.split('/').pop(), '') + 'ffmpeg_asm.js';
var workerPath = 'https://googledrive.com/host/0B6GWd_dUUTT8OEtLRGdQb2pibDg/ffmpeg_asm.js';

function processInWebWorker() {
    var blob = URL.createObjectURL(new Blob(['importScripts("' + workerPath + '");var now = Date.now;function print(text) {postMessage({"type" : "stdout","data" : text});};onmessage = function(event) {var message = event.data;if (message.type === "command") {var Module = {print: print,printErr: print,files: message.files || [],arguments: message.arguments || [],TOTAL_MEMORY: 268435456};postMessage({"type" : "start","data" : Module.arguments.join(" ")});postMessage({"type" : "stdout","data" : "Received command: " +Module.arguments.join(" ") +((Module.TOTAL_MEMORY) ? ".  Processing with " + Module.TOTAL_MEMORY + " bits." : "")});var time = now();var result = ffmpeg_run(Module);var totalTime = now() - time;postMessage({"type" : "stdout","data" : "Finished processing (took " + totalTime + "ms)"});postMessage({"type" : "done","data" : result,"time" : totalTime});}};postMessage({"type" : "ready"});'], {
        type: 'application/javascript'
    }));

    var worker = new Worker(blob);
    URL.revokeObjectURL(blob);
    return worker;
}

var worker;

function convertStreams(videoBlob, audioBlob) {
    var vab;
    var aab;
    var buffersReady;
    var workerReady;
    var posted = false;

    var fileReader1 = new FileReader();
    fileReader1.onload = function() {
        vab = this.result;

        if (aab) buffersReady = true;

        if (buffersReady && workerReady && !posted) postMessage();
    };
    var fileReader2 = new FileReader();
    fileReader2.onload = function() {
        aab = this.result;

        if (vab) buffersReady = true;

        if (buffersReady && workerReady && !posted) postMessage();
    };

    fileReader1.readAsArrayBuffer(videoBlob);
    fileReader2.readAsArrayBuffer(audioBlob);

    if (!worker) {
        worker = processInWebWorker();
    }

    worker.onmessage = function(event) {
        var message = event.data;
        if (message.type == "ready") {
            workerReady = true;
            if (buffersReady)
                postMessage();
        } else if (message.type == "stdout") {
        } else if (message.type == "start") {
        } else if (message.type == "done") {

            var result = message.data[0];
            log(JSON.stringify(result));

            var blob = new Blob([result.data], {
                type: 'video/mp4'
            });

            log(JSON.stringify(blob));

            PostBlob(blob);
        }
    };
    var postMessage = function() {
        posted = true;

        worker.postMessage({
    type: 'command',
    arguments: ['-i', 'video.webm',
        '-i', 'audio.wav',
        '-c:v', 'mpeg4',
        '-c:a', 'vorbis',
        '-b:v', '9600k',
        '-b:a', '128k',
        '-strict', 'experimental', 'output.mp4'
    ],
    files: [{
        data: new Uint8Array(vab),
        name: 'video.webm'
    }, {
        data: new Uint8Array(aab),
        name: "audio.wav"
    }]
});
    };
}

//var h2 = document.querySelector('h2');
 var h2 = document.getElementById('download-url');

function PostBlob(blob) {
    h2.innerHTML = '<a href="' + URL.createObjectURL(blob) + '" target="_blank" download="RecordedAudioCanvas.mp4">Save</a>';
   document.getElementById('download-url').disabled = false;
    //h2.setAttribute('contenteditable', 'false');
}

function log(message) {
    h2.innerHTML = message;
    console.log(message);
}
  var video = document.querySelector("#videoElement");
         
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia || navigator.oGetUserMedia;
         
        if (navigator.getUserMedia) {      
            navigator.getUserMedia({video: true, audio: false}, handleVideo, videoError);
        }
         
        function handleVideo(stream) {
            video.src = window.URL.createObjectURL(stream);
        }
         
        function videoError(e) {
            alert('ERROR');
        }


</script>